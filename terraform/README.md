# sf-c0406-hw-elasticsearch-logshipper-kibana
For Skill Factory study project (C04, HW2) :: Comments

<br>

### Terraform Configuration: Описание директив

```bash
#00 :: создание токена авторзации (со сроком жизни 12 часов)
    $ export TF_VAR_yc_token=$(yc iam create-token) && echo $TF_VAR_yc_token

#01 :: Подключение облачного провайдера
  required_providers
    yandex
      version = "0.84.0" # версию необходимо указать только при первичной инициализации Terraform

#02 :: Локальные переменные
locals
    iam_token           # iam токен авторизации
    cloud_id            # id облака
    folder_id           # id каталога
    access_zone         # зона доступности (размещение ВМ в конкретном датацентре)
    netw_name           # имя сети
    net_id              # id сети (существующей, если производится подключение к ранее созданной сети)
    net_sub_name        # имя подсети (существующей или создаваемой)
    net_sub_id          # id подсети (существующей, если производится подключение к ранее созданной сети)
    vm_default_login    # пользователь по-умолчанию (встроенный) для Ubuntu образов из Yandex Cloud Marketplace
    ssh_keys_dir        # локальный каталог размещения ключевой ssh-пары на локальном хосте
    ssh_pubkey_path     # публичный ssh-ключ для авторизации по ключу на серверах
    ssh_privkey_path    # приватный ssh-ключ для авторизации по ключу на серверах
    vm1_name            # отображаемое в списке имя ВМ1
    vm1_hostname        # сетевое имя ВМ1
    vm1_ipv4_local      # IPv4-адрес создаваемого локального интерфейса ВМ1
    vm1_disk0size       # выделяемый размер загрузочного диска для ВМ1, ГБ (от 8 ГБ, далее зависит от задач)

#03 :: Авторизация на стороне провайдера и указание Ресурсов с которыми будет работать Terraform
#      Connects to Cloud with Cloud ids

#04 :: Описание создаваемых ресурсов ВМ/инстанса
resource "yandex_compute_instance"

    name                # отображаемое имя ВМ
    hostname            # сетевое имя хоста ВМ
    platform_id         # аппартатная платформа ВМ (влияет на тип и параметры доступного для выбора CPU)
    zone                # зона доступности

    ## Конфигурация виртуальных CPU и RAM
    resources
        cores           # колво виртуальных ядер vCPU
        memory          # размер оперативной памяти, ГБ
        core_fraction   # % гарантированной доли CPU (самый дешевый вариант, при 100% вся процессорная мощность резервируется для клиента)

    ## Конфигурация технического обслуживания по расписанию
    scheduling_policy
        preemptible     # делаем ВМ прерываемой (ВМ становится дешевле на 50%, но ее в любой момент могут вырубить что происходит не часто)


    ## Конфигурация загрузочного диска (включает образ на основе которого создается ВМ (из Yandex.Cloud Marketplace)
    boot_disk 
        initialize_params
        image_id        # версия ОС: Ubuntu 22.04 LTS (family_id: ubuntu-2204-lts, image_id: fd8clogg1kull9084s9o)
        type            # тип загрузочного носителя (network-hdd | network-ssd)
        size            # размер диска, ГБ (меньше 8 ГБ для образа "Ubuntu 22.04" выбрать нельзя)
        description     # описание ВМ (не обязательно)

    ## Конфигурация сетевого интерфейса
    network_interface
        subnet_id       # идентификатор подсети в которую будет смотреть интерфейс
        ip_address      # назначение внутреннего IPv4 адреса ВМ
        nat             # создание интерфейса смотрящий в публичную сеть


    ## Конфигурация авторизации пользователей на создаваемой ВМ
    metadata
        serial-port-enable  # активация серийной консоли чтоб можно было подключиться к ВМ через веб-интерфейс (0, 1);
        ssh-keys            # передаем публичный ssh ключ который будет добавлен на ВМ в /home/ubuntu/.ssh/authorized_keys

#05 :: Выполнение шелл-команд на создаваемой ВМ и локально
resource "yandex_compute_instance"
    ## Копирование файлов #1
    ## Копируем каталог с ssh-ключами из локального хоста на создаваемую ВМ (для дальнейшего создания учетной записи "devops")
    provisioner "file"
        #..блок параметров ssh подключения к ВМ (обязательно)
        connection

    ## Копирование файлов #2
    ## Копируем шелл-скрипт из локального хоста на создаваемую ВМ
    provisioner "file"
        #..блок параметров ssh подключения к ВМ (обязательно)
        connection

    ## Выполнение команд на целевой ВМ после того как ВМ будет создана
    ## *выполняем шелл мастер-скрипт который будет запускать другие конфигурационные шелл-скрипты
    provisioner "remote-exec"
        #..блок параметров ssh подключения к ВМ (обязательно)
        connection

```
<br>


### Terraform Configuration: Network

```bash
#01
- В Сервисе "Virtual Private Cloud" (vpc) Создаем Сеть "acme-net" и подсеть "acme-net-sub1"
  *если в облаке уже существует такая сеть созданная ранее, то возникнет ошибка изза превышения квоты на кол-во сетей (не более 2х включая "default" сеть)
       rpc error: code = ResourceExhausted desc = Quota limit vpc.networks.count exceeded
  *такая сеть уже была создана ранее в предыдущем проекте, поэтому ее создание НЕ требуется и блок закомментирован

        resource "yandex_vpc_network" "net1" {
            name = "acme-net" # имя сети так она будет отображаться в веб-консоли (чуть выше "net1" - это псевдоним ресурса);
        }

  *тоже самое это относится и к подсети :: подсеть уже была создана ранее в предыдущем проекте, поэтому ее создание НЕ требуется и блок закомментирован

        resource "yandex_vpc_subnet" "subnet1" {
        name           = "acme-net-sub1"              # имя подсети;
        zone           = local.access_zone            # зона доступности (из локальной переменной);
        network_id     = yandex_vpc_network.net1.id   # связь подсети с сетью по id (net1 - это созданный псевдоним Ресурса);
        v4_cidr_blocks = ["10.0.10.0/28"]             # адресное IPv4 пространство подсети;
        }

- для подключения создаваемой ВМ к уже существующей сети и подсети, необходимо указать ее идентификатор в:

        network_interface {
            subnet_id = yandex_vpc_subnet.subnet1.id
            ..
        }

```
<br>

### Terraform and Ansible

```bash
#01: Применение Ansible для настройки серверов:
- т.к Ansible реализует свой способ описания конфигураций настраиваемоего хоста на основе yaml конфигурациии и собственного языка,
  это приводит к тому, что появляется дополнительный слой абстракции (и сложности) от которого можно избавится применяя обычные шелл-скрипты
  которые, на мой взгляд, более читабельные и понятные чем Ansible yaml конфигурации
- тем не менее, использование Ansible будет скорее всего обосновано когда нужно настраивать множество групп хостов с разными конфигурациями
  и в этом сценарии применение обычных шелл-скриптов было-бы затруднено необходимостью создания их копий с различными изменениями логики настройки хоста
- при настройке однотипных хостов или небольших групп хостов, я считаю что применение Ansible не целесообразно (поэтому в данном проекте я не применяю Ansible)

      provisioner "local-exec" {
        ##--Применяем Ansible Плейбук "nginx" к инстансу "host1"
        ##  example: ansible-playbook -i 84.252.139.210, -u ubuntu -e host_public_ip_phpfpm=158.160.28.188 ./ansible/deploy_nginx.yml
        command = "ANSIBLE_HOST_KEY_CHECKING=False ANSIBLE_ASK_PASS=False ansible-playbook -i '${yandex_compute_instance.host1.network_interface.0.nat_ip_address},' -u ${local.vm_default_login} -e host_public_ip_phpfpm=${yandex_compute_instance.host2.network_interface.0.nat_ip_address} ./ansible/deploy_nginx.yml"
        #
      } ## << "provisioner local-exec"

```
<br>
